==============================================
Solar ESS Manager - 프로젝트 분석 보고서
날짜: 2025-12-01
분석자: Claude Code 심층 재분석
==============================================

## 프로젝트 개요
Solar ESS Manager (S.E.M) - 태양광 에너지 저장 시스템 스마트 관리 플랫폼
팀명: "Watt's Up?" (OWK, ATH, LMG, YTH, CHY)
현재 브랜치: owk (개발 브랜치)
메인 브랜치: main

==============================================
## 🚨 중요: 커밋되지 않은 변경사항 발견
==============================================

### 백엔드 대규모 리팩토링 진행 중 (커밋 안됨)
git diff 분석 결과, 아직 커밋되지 않은 엄청난 양의 백엔드 변경사항 발견:

1. **서비스 레이어 완전 재구조화**
   - 새로운 에러 처리 시스템 추가 (DBException 클래스, handle_errors 데코레이터)
   - db_transaction 컨텍스트 매니저로 DB 연결 관리 개선
   - config.json을 services/에서 config/ 폴더로 이동 (config_arduino.json으로 이름 변경)
   - common_service.py에 CHANNEL_CONFIG 전역 변수 추가

2. **스케줄 작업 시스템 추가**
   - __init__.py에 APScheduler 추가
   - 새 함수: aggregate_old_data (매시간 정각에 실행)
   - 메인 Werkzeug 프로세스에서만 실행

3. **데이터베이스 스키마 변경**
   - 새 테이블: sun_data_realtime, sun_data_hourly
   - 기존 테이블은 유지: sun_data
   - 과거 데이터를 시간별로 집계하는 시스템

4. **API 라우트 변경**
   - /api/relay/control이 이제 DB 상태를 반환함 (릴레이 제어에서 변경됨)
   - 새 엔드포인트: /api/relay/update (실제 릴레이 제어용)
   - 에너지 예측이 이제 별도 서비스 함수 사용
   - 에러 메시지 개선 (한글 → 영어)

5. **센서 서비스 대규모 업데이트**
   - aggregate_old_data() 함수 추가 (데이터 아카이빙용)
   - 데이터 검증 개선 (범위 체크: 0 <= soc <= 100 등)
   - 실시간 데이터와 시간별 데이터 저장 분리

6. **릴레이 서비스 재구조화**
   - 새 함수: reset_relay() - 시작 시 모든 릴레이를 OFF로 자동 리셋
   - 새 함수: save_relay_state_changes() - OFF→ON 전환 처리
   - 메인 플로우에서 아두이노 직접 통신 제거
   - 데코레이터를 통한 에러 처리 개선

7. **.gitignore 업데이트**
   - test.py를 무시 목록에 추가

### 프론트엔드 변경사항 (수정된 파일들)

**Home.jsx** (수정됨)
- 기능적 변경 없음
- framer-motion으로 스크롤 애니메이션
- 한글 콘텐츠로 7개 섹션
- 플레이스홀더 GitHub URL: https://github.com/example/Solar-ESS-Manager

**Trade.jsx** (수정됨)
- 73-80줄: 신규 코드 - localStorage에서 houseEnergy 읽기
- EnvSetting 페이지와 가구별 에너지 값 동기화
- 백엔드 가용성에 따라 가상/실제 모드 전환
- 실시간 업데이트용 Socket.IO 사용
- localStorage 저장: solarData, houseEnergy, cashBalance, tradeHistory
- PRICE_PER_WATT: 140원 (하드코딩)
- 각 가구는 거래당 100W (하드코딩)

**EnvSetting.jsx** (수정됨)
- 165줄: 신규 코드 - 초기화 시 houseEnergy를 localStorage에 저장
- 234-236줄: 신규 코드 - setRelayPower가 이제 houseEnergy localStorage에 저장
- 254-256줄: 신규 코드 - fillDefaultStats도 houseEnergy 설정
- 기본값: A:50W, B:100W, C:75W, D:120W
- 연결 체크: 데이터가 5분 미만 경과해야 "실제" 모드
- 가상 모드는 모든 데이터를 localStorage에 저장

### 추적되지 않은 파일
- frontend/img/dfdfd.af (정체불명 이미지 파일)
- node_modules/ (.gitignore에 있어야 함)
- 루트의 package.json + package-lock.json (Socket.IO client 의존성)

==============================================
## 상세 코드 아키텍처
==============================================

### 프론트엔드 구조

**페이지들:**
1. Home.jsx - 7개 섹션 애니메이션 소개
   - 휠 이벤트로 섹션 네비게이션
   - Framer Motion slideVariants 애니메이션
   - 팀 정보에 5명 모두의 이메일 포함
   - 기술 스택 테이블: JavaScript, Python, React, Express

2. Statistics.jsx - 더미 데이터 대시보드
   - DUMMY_ENERGY_DATA: 8개 시간대 (00:00-21:00)
   - DUMMY_HOURLY_DATA: 5개 시간대 (00시-24시)
   - 막대 차트: 4개 가구 (A, B, C, D), 색상 #FFD900, #82ca9d, #DCDCDC, #515151
   - 선 차트: 오늘 vs 어제 비교
   - 하드코딩된 최적값: A:10W, B:3W, C:5W, D:2W
   - 하드코딩된 일사량: 10 MJ/㎡
   - 참고: 매일 00시에 초기화

3. Trade.jsx - 핵심 거래 기능
   - BACKEND_URL: http://localhost:5000
   - Socket 이벤트: relay_status_update, new_sun_data
   - 에너지 잔액 계산: (soc/100) * 10000
   - 기본 현금: 48020원
   - 거래 구조: {date, houses, watt, price}
   - 색상 구성: 선택된 가구는 노란색 (#FFB300)

4. EnvSetting.jsx - 설정 페이지
   - 3가지 연결 상태: 'checking', 'real', 'virtual'
   - 실제 모드: 백엔드 OK + 아두이노 데이터 5분 이내
   - 가상 모드: localStorage 사용
   - 수동 설정: SOC, solar_w, lux, 현금, A/B/C/D 전력
   - 자동 모드: 랜덤 값 (SOC: 60-100%, 태양광: 50-200W, 조도: 20000-50000)
   - 초기화 기능: 모든 것을 0으로 리셋
   - 기본 통계값: SOC:80%, 태양광:150W, 조도:35000, 현금:48020

5. Arduino.jsx - 레퍼런스 문서 (플레이스홀더)
   - 3개 탭: CIRCUITS, VIDEO, FLOWCHART

**컴포넌트:**
- Navbar.jsx - 네비게이션 컴포넌트

**의존성 (package.json):**
- react: 19.2.0
- react-dom: 19.2.0
- recharts: 3.4.1 (차트용)
- socket.io-client: 4.8.1 (실시간 통신용)
- motion: 12.23.24 (Framer Motion)
- vite: 7.2.2 (개발/빌드)

### 백엔드 구조 (FLASK)

**진입점:**
- run.py (읽지 않았지만 존재함)

**앱 팩토리:**
- app/__init__.py
  - Flask 앱 생성
  - 4개 블루프린트 등록
  - APScheduler 설정 (시간별 데이터 집계)
  - /api/*에 대해 CORS 활성화

**블루프린트:**
1. data_routes.py
   - GET /api/data/latest - 최신 센서 데이터 조회
   - POST /api/data/solar - 아두이노 데이터 수신
   - GET /api/data/history - 거래 내역 조회 (필터: user_id, start_date, end_date, date)

2. relay_routes.py (변경됨)
   - POST /api/relay/update - 릴레이 상태 업데이트 (신규)
   - GET /api/relay/status - 현재 릴레이 상태 조회
   - POST /api/relay/control - 아두이노용 DB 릴레이 상태 반환 (변경됨)

3. channels_routes.py
   - POST /api/channels/available - 사용 가능한 채널 조회
   - POST /api/channels/optimal - 최적 조합 조회

4. energy_routes.py
   - POST /api/energy/predict - ML 예측 (1h, 2h, 3h)

**서비스:**
1. sensor_service.py
   - get_latest_sensor_data() - sun_data_realtime에서 읽기
   - save_sensor_data() - sun_data_realtime에 저장
   - aggregate_old_data() - 오래된 데이터를 sun_data_hourly로 이동 (신규)

2. relay_service.py
   - update_relay_status_in_db() - 릴레이 상태 저장
   - insert_trade_history() - 거래 기록 저장
   - get_trade_history() - trade_history 테이블 쿼리
   - get_current_relay_status() - relay_status 테이블 읽기
   - send_to_arduino() - 아두이노로 HTTP POST
   - get_active_relay_list() - ON 상태 릴레이 필터링
   - reset_relay() - 모든 릴레이를 OFF로 설정 (신규)
   - save_relay_state_changes() - OFF→ON 전환 처리 (신규)

3. channels_service.py
   - get_optimal_combination() - 최적 전력 분배 찾기
   - get_available_channels() - 활성화 가능한 채널 확인
   - itertools.combinations로 모든 조합 생성
   - 배터리 보호: SOC < 10%면 판매 차단

4. energy_service.py
   - get_latest_sensor_data_for_model() - ML용 데이터 가져오기
   - predict_solar_generation() - RandomForest 예측 실행
   - lux_to_insolation() - lux를 MJ/㎡로 변환 (lux * 0.0079 * 0.0036)
   - @lru_cache로 모델 로드 (1회만)
   - 모델 경로: models/rf_production_model.pkl (rf_best_model.pkl에서 변경됨)

5. common_service.py (대규모 변경)
   - get_buyer_id_from_channel() - A→1, B→2, C→3, D→4 매핑
   - CHANNEL_CONFIG - config 파일의 전역 딕셔너리
   - DBException - 커스텀 예외 클래스 (신규)
   - handle_errors() - 에러 처리 데코레이터 (신규)
   - db_transaction() - DB 작업용 컨텍스트 매니저 (신규)

**데이터베이스:**
- db.py - MySQL 커넥터
- 환경 변수 사용: DB_HOST, DB_USER, DB_PASSWORD, DB_DATABASE
- dictionary=True인 커서 반환

**설정:**
- config/config_arduino.json (services/config.json에서 이동)
  - battery_capacity_wh: 11.1
  - channel_config: A:10W, B:30W, C:25W, D:30W
  - duration_minutes: 5
  - battery_protection_threshold: 10%

### 머신러닝

**모델:**
- 타입: RandomForest Regressor
- 위치: models/rf_production_model.pkl (55MB 예상)
- 학습 스크립트: ml/model_train_rf.py

**피처:**
1. year (연도)
2. month (월)
3. day (일)
4. time (시간)
5. generation (현재 solar_w)
6. prev_generation (1시간 전)
7. yesterday_generation (어제 같은 시간)
8. insolation (lux에서 변환)

**출력:**
- 3가지 예측: 1시간, 2시간, 3시간 후 발전량 (와트)
- 소수점 2자리까지 반올림

**데이터 파이프라인:**
1. sun_data_realtime에서 현재 데이터 가져오기
2. 1시간 전 데이터를 위한 LAG 쿼리 (prev_generation)
3. 어제 같은 시간을 위해 sun_data_hourly 쿼리
4. lux → insolation 변환
5. Model.predict()가 (1, 3) 배열 반환
6. {1h: float, 2h: float, 3h: float} 반환

### 데이터베이스 스키마 (MySQL)

**테이블 (새 구조):**
1. sun_data_realtime - 실시간 센서 데이터
   - soc (배터리 %)
   - solar_w (전력 생산량)
   - lux (조도)
   - timestamp

2. sun_data_hourly - 시간별 집계 데이터 (신규)
   - date
   - hour
   - avg_soc
   - avg_solar_w
   - avg_lux

3. sun_data - 원래 테이블 (여전히 존재)

4. relay_status - 릴레이 상태
   - relay_name (A, B, C, D)
   - status (on/off)

5. trade_history - 거래 로그
   - id
   - buyer_id (1, 2, 3, 4)
   - amount (와트)
   - timestamp

==============================================
## 핵심 비즈니스 로직
==============================================

### 에너지 거래 플로우:
1. 사용자가 가구 선택 (A, B, C, D)
2. 각 가구 = 100W
3. energyBalance >= totalWatt 확인
4. 릴레이 상태 업데이트 (OFF → ON = 새 거래)
5. totalPrice = totalWatt * 140 계산
6. 에너지 차감, 현금 추가
7. 타임스탬프와 함께 거래 기록
8. 백엔드와 동기화 (실제 모드일 경우)

### 채널 최적화:
1. 가용 전력 계산 = battery_w + solar_w
   - battery_w = (battery_capacity_wh * soc/100) / (duration_min/60)
2. 모든 조합 생성 (1-4개 채널)
3. 유효한 조합 필터링 (total_power <= available_power)
4. 최선 선택: max(채널 수, 그 다음 max(전력))
5. SOC < 10%면, 모든 채널 False 반환

### 데이터 집계 (신규):
- 매시간 정각에 실행
- sun_data_realtime → sun_data_hourly로 이동
- 날짜 + 시간으로 그룹화
- soc, solar_w, lux의 평균 계산

### 실제 모드 vs 가상 모드:
**실제 모드:**
- 백엔드가 /api/data/latest에 응답
- 데이터 타임스탬프가 5분 미만
- Socket.IO 연결됨
- 업데이트가 DB로 전파됨

**가상 모드:**
- localStorage만 사용
- 백엔드 통신 없음
- 오프라인 테스트 완전 작동
- 백엔드 재연결 시 동기화

==============================================
## 잠재적 문제 및 참고사항
==============================================

1. **중요: 모델 파일 불일치**
   - energy_service.py 예상: rf_production_model.pkl
   - 실제 모델 파일 이름 확인 필요

2. **커밋되지 않은 변경사항**
   - 거대한 백엔드 리팩토링 진행 중
   - API 계약 변경 (/api/relay/control 동작 변경됨)
   - 백엔드가 프론트엔드 업데이트 없이 커밋되면 프론트엔드가 망가질 수 있음

3. **루트의 node_modules**
   - 루트 package.json에 socket.io-client만 있음
   - .gitignore에 있어야 하지만 없음
   - 테스트 목적일 가능성

4. **하드코딩된 값들**
   - PRICE_PER_WATT: 140 (Trade.jsx)
   - 기본 현금: 48020 (여러 곳)
   - 가구당 와트: 100 (Trade.jsx)
   - 배터리 용량: 11.1Wh (config)

5. **통계 페이지**
   - 100% 더미 데이터 사용
   - 백엔드 통합 없음
   - 하드코딩된 최적값
   - 하드코딩된 일사량 값

6. **GitHub URL**
   - Home.jsx의 플레이스홀더: https://github.com/example/Solar-ESS-Manager
   - 실제 레포로 업데이트 필요

7. **기술 스택 불일치**
   - Home.jsx: "React, Express"라고 표시
   - 실제로는: React, Flask 사용
   - "React, Flask"로 업데이트 필요

8. **데이터베이스 테이블**
   - 여러 sun_data 테이블 (realtime, hourly, 원본)
   - 마이그레이션 전략 불명확
   - 오래된 코드가 sun_data_realtime 대신 sun_data를 참조할 수 있음

9. **Socket.IO**
   - 백엔드에 이전에 SocketIO가 있었음 (커밋되지 않은 변경사항에서 제거됨?)
   - 프론트엔드는 여전히 Socket.IO 이벤트 기대
   - 백엔드 변경사항이 커밋되면 잠재적 불일치

10. **언어 혼용**
    - UI: 한국어
    - 코드 주석: 한국어
    - API 에러 메시지: 이제 영어 (신규)
    - 콘솔 로그: 한국어

==============================================
## 파일 위치 참조
==============================================

프론트엔드:
- /frontend/src/pages/Home.jsx
- /frontend/src/pages/Statistics.jsx
- /frontend/src/pages/Trade.jsx
- /frontend/src/pages/EnvSetting.jsx
- /frontend/src/pages/Arduino.jsx
- /frontend/src/components/Navbar.jsx
- /frontend/package.json

백엔드:
- /backend/api/app/__init__.py
- /backend/api/app/db.py
- /backend/api/app/routers/data_routes.py
- /backend/api/app/routers/relay_routes.py
- /backend/api/app/routers/channels_routes.py
- /backend/api/app/routers/energy_routes.py
- /backend/api/app/services/sensor_service.py
- /backend/api/app/services/relay_service.py
- /backend/api/app/services/channels_service.py
- /backend/api/app/services/energy_service.py
- /backend/api/app/services/common_service.py
- /backend/api/app/config/config_arduino.json (이동됨)
- /backend/api/run.py

머신러닝:
- /ml/model_train_rf.py
- /models/rf_production_model.pkl (예상)
- /models/rf_best_model.pkl (존재할 수 있음)

==============================================
## 최근 커밋 내역
==============================================

c88b127 (HEAD) 2025-11-24 OWK: 중간커밋
68aa643 2025-11-20 OWK: daily commit
53d04f0 2025-11-19 OWK: 가상환경 세팅 수정 및 거래 화면 수정
d79ba1a 2025-11-11 OWK: UI 개선
27cb5ae 2025-11-13 OWK: 일부 페이지 UI 다듬기
54eebdb 2025-11-11 OWK: 전체적인 진행 및 코드 정리

==============================================
## 첫 분석과 비교한 변경사항 요약
==============================================

**새로 발견한 내용:**

1. **거대한 커밋되지 않은 백엔드 리팩토링**
   - 완전한 서비스 레이어 재구조화
   - 데코레이터를 사용한 새 에러 처리 시스템
   - 데이터베이스 스키마 변경 (realtime vs hourly)
   - API 엔드포인트 동작 변경
   - 스케줄 작업 시스템 추가

2. **프론트엔드-백엔드 동기화**
   - Trade.jsx와 EnvSetting.jsx가 이제 localStorage를 통해 동기화
   - houseEnergy 추적 추가
   - 가상/실제 모드 분리 개선

3. **모델 파일 이름 문제**
   - 코드에서 rf_production_model.pkl 참조
   - 실제 파일과 다를 수 있음

4. **통계 페이지 세부사항**
   - 100% 더미 데이터 확인
   - 실제 백엔드 통합 없음
   - 특정 색상 코드 문서화

5. **설정 파일 마이그레이션**
   - config.json이 services/에서 config/로 이동
   - 이제 config_arduino.json으로 명명

6. **릴레이 제어 플로우 변경**
   - /api/relay/control의 목적이 변경됨
   - 새로운 /api/relay/update 엔드포인트
   - 시작 시 리셋 기능

7. **데이터 집계 시스템**
   - APScheduler 통합
   - 별도 테이블로 시간별 집계
   - 더 나은 과거 데이터 관리

**첫 분석에서 확인된 내용:**
- 팀 구조 (5명)
- 기술 스택 (React + Flask, Express 아님)
- 핵심 기능 (거래, 통계, 예측)
- 가상/실제 모드 아키텍처
- 실시간 업데이트용 Socket.IO
- ML 모델 (RandomForest)
- 배터리 보호 로직
- 채널 최적화 알고리즘

==============================================
## 주요 발견사항 요약
==============================================

✅ **잘 되어 있는 점:**
- 체계적인 프론트엔드/백엔드 분리
- 가상 모드로 오프라인 테스트 가능
- ML 모델 통합 구조 양호
- localStorage를 통한 데이터 지속성
- 실시간 Socket.IO 통신

⚠️ **주의가 필요한 점:**
- 커밋되지 않은 대규모 백엔드 변경사항
- API 엔드포인트 동작 변경으로 인한 호환성 문제 가능성
- Statistics 페이지는 아직 더미 데이터만 사용
- Home.jsx에 기술 스택 오타 (Express → Flask로 수정 필요)
- GitHub URL 플레이스홀더
- 루트에 node_modules 존재 (정리 필요)

🔧 **권장 조치사항:**
1. 백엔드 변경사항 커밋 전 프론트엔드와 호환성 확인
2. Statistics 페이지 실제 데이터 연동 구현
3. Home.jsx 기술 스택 정보 수정
4. GitHub URL 업데이트
5. 루트 node_modules .gitignore 추가 검토
6. 모델 파일명 확인 (rf_production_model.pkl vs rf_best_model.pkl)

==============================================
보고서 끝
==============================================
